---
meta:
  size: default
  instances: 3
  default:
    azs: [z1,z2]
  username: (( vault $CREDENTIALS "/rabbitmq/system:username" ))
  password: (( vault $CREDENTIALS "/rabbitmq/system:password" ))
  environment: <%= p('environment') %>
  bosh_env: <%= p('bosh_env') %>

variables:
- name: rabbitmq_cluster_crt
  type: certificate
  options:
    ca: (( concat "/" meta.bosh_env "-bosh/" meta.environment "-blacksmith/blacksmith_services_ca" ))
    common_name: (( concat meta.environment "-rabbitmq-cluster.bosh" ))
  consumes:
    alternative_name: 
      from: rabbitmq-san 
      properties: { wildcard: true }

features:
  use_dns_addresses: true

releases:
  - { name: rabbitmq-forge, version: latest }

stemcells:
- alias: default
  os: ubuntu-bionic
  version: latest

update:
  canaries: 1
  max_in_flight: 10
  canary_watch_time: 1000-30000
  update_watch_time: 1000-30000

instance_groups:
  - name: node
    instances: (( grab meta.instances ))
    azs: (( grab meta.azs || meta.default.azs ))
    networks: [name: (( grab meta.net || 'rabbitmq-service' ))]
    stemcell: default

    vm_type: (( grab meta.size ))

    jobs:
      - name:    rabbitmq
        release: rabbitmq-forge
        properties:
          default_user:     (( grab meta.username ))
          default_password: (( grab meta.password ))
          rabbitmq:
            vhost: (( grab meta.params.instance_id || "/" ))
            network: (( grab meta.net || "rabbitmq-service" ))
            
            tls:
              enabled: (( grab meta.rabbitmq.tls.enabled || false ))
              dual-mode: (( grab meta.rabbitmq.tls.dual-mode || false ))
              ca: (( file "/var/vcap/jobs/blacksmith/config/tls/blacksmith_services_ca" ))
              crt: ((rabbitmq_cluster_crt.certificate))
              key: ((rabbitmq_cluster_crt.private_key))

        provides:
          rabbitmq-servers:
            as: rabbitmq-servers
            ip_addresses: false
          rabbitmq-san:
            as: rabbitmq-san
            ip_addresses: false
          rabbitmq-alias-domain:
            aliases:
            - domain: "_.rabbitmq_standalone.bosh"
              placeholder_type: uuid
        consumes:
          rabbitmq-servers:
            from: rabbitmq-servers
            ip_addresses: false
        custom_provider_definitions:
        - name: rabbitmq-san  
          type: address
        - name: rabbitmq-alias-domain
          type: placeholder
