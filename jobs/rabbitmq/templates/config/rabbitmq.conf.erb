<% if ! p("rabbitmq.tls.enabled") || (p("rabbitmq.tls.enabled") && p("rabbitmq.tls.dual-mode")) -%>
listeners.tcp.default = <%= p('port') %> # 5672
<% end -%>

<% if p("rabbitmq.tls.enabled") -%>
# https://www.rabbitmq.com/ssl.html

# TLS Listener is on port 5671
listeners.ssl.1 = <%= p("rabbitmq.tls.port") %>
# TLS Certificates
ssl_options.cacertfile           = /var/vcap/jobs/rabbitmq/tls/rabbitmq.ca
ssl_options.certfile             = /var/vcap/jobs/rabbitmq/tls/rabbitmq.crt
ssl_options.keyfile              = /var/vcap/jobs/rabbitmq/tls/rabbitmq.key
ssl_options.verify               = verify_peer
ssl_options.fail_if_no_peer_cert = true
# All TLS v1.2 RFC Supported Ciphers
ssl_options.versions.1 = tlsv1.2
ssl_options.ciphers.1  = TLS_RSA_WITH_AES_256_GCM_SHA384         # AES256-GCM-SHA384
ssl_options.ciphers.2  = TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA      # ECDHE-RSA-AES256-SHA
ssl_options.ciphers.3  = TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384   # ECDHE-RSA-AES256-GCM-SHA384
ssl_options.ciphers.4  = TLS_RSA_WITH_AES_128_GCM_SHA256         # AES128-GCM-SHA256
ssl_options.ciphers.5  = TLS_ECDHE_RSA_WITH_RC4_128_SHA          # ECDHE-RSA-RC4-SHA
ssl_options.ciphers.6  = TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA      # ECDHE-RSA-AES128-SHA
ssl_options.ciphers.7  = TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256   # ECDHE-RSA-AES128-GCM-SHA256
ssl_options.ciphers.8  = TLS_RSA_WITH_AES_128_CBC_SHA256         # AES128-SHA256
ssl_options.ciphers.9  = TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256   # ECDHE-RSA-AES128-SHA256
# NOTE: vvv Disable these two below for tlsv1.3 vvv
ssl_options.honor_cipher_order   = true
ssl_options.honor_ecc_order      = true
# Troubleshooting: https://www.rabbitmq.com/troubleshooting-ssl.html
<% end -%>
